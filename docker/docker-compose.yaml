
services:

  multiservice-discovery:
    image: ghcr.io/dfinity/dre/multiservice-discovery:cac3154c7868faf9acad14f8585d37df27169573
    network_mode: host
    command:
      - --targets-dir
      - /msd
      - --networks-state-file
      - /msd/definitions.json
    volumes:
      - ./volumes/msd:/msd

  prometheus:
    image: quay.io/prometheus/prometheus:v2.51.1
    network_mode: host
    volumes:
      - ./config/prometheus:/config
      - ./volumes/prometheus/:/prometheus
    command:
      - --config.file
      - /config/config.yaml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=6m
    user: "${UID}:${GID}"
    deploy:
      resources:
        limits:
          memory: 12G
        reservations:
          memory: 12G

  influxdb:
    image: influxdb:2.7
    network_mode: host
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: adminpassword
      DOCKER_INFLUXDB_INIT_ORG: ic-org
      DOCKER_INFLUXDB_INIT_BUCKET: node-rewards
      DOCKER_INFLUXDB_INIT_RETENTION: 90d
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: my-super-secret-auth-token
    volumes:
      - ./volumes/influxdb:/var/lib/influxdb2

  # node-rewards-scheduler:
  #   image: ghcr.io/dfinity/dre/dre:latest
  #   network_mode: host
  #   environment:
  #     INFLUXDB_URL: http://localhost:8086
  #     INFLUXDB_TOKEN: my-super-secret-auth-token
  #     INFLUXDB_ORG: ic-org
  #     INFLUXDB_BUCKET: node-rewards
  #   volumes:
  #     - ./volumes/node-rewards-scheduler:/scheduler
  #     - ./config/node-rewards-scheduler/entrypoint.sh:/entrypoint.sh:ro
  #   entrypoint: /entrypoint.sh
  #   depends_on:
  #     - influxdb

  grafana:
    image: grafana/grafana:12.2.1
    network_mode: host
    environment:
      PROM_HOST: localhost
    volumes:
      - ./config/grafana:/etc/grafana
      - ./volumes/grafana:/var/lib/grafana
    user: "${UID}:${GID}"
    depends_on:
      - influxdb
